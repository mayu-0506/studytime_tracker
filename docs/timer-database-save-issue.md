# タイマー終了時のデータベース保存問題の調査

## 現状の確認

### 1. 実装状況
**実装済みの機能**:
- タイマー終了時に`end_time`と`duration`を保存する処理は実装済み
- `/hooks/useStudyTimer.ts`のstop関数で処理
- `/actions/study-sessions.ts`のupdateSession関数でDB更新

### 2. 単位の不整合
**問題点**:
- 現在の実装: duration を**分単位**で保存
- 要件定義: duration を**秒単位**で保存
- RPC関数（dashboard_totals等）: **分単位**を期待

### 3. デバッグログの追加
以下の箇所にデバッグログを追加しました：
- `useStudyTimer.ts`: 計算されたduration（分）を表示
- `study-sessions.ts`: 実際にDBに送信されるデータを表示

## 考えられる原因

### 1. 単位の不一致
- データベースが秒単位を期待しているが、分単位で送信している
- または逆の可能性

### 2. 計算の問題
- start_timeがnullまたは不正な値
- 時刻の計算でタイムゾーンの問題

### 3. 権限の問題
- RLSポリシーでUPDATE権限がない
- user_idの不一致

## 次のステップ
1. ブラウザのコンソールでデバッグログを確認
2. Supabaseのダッシュボードでテーブル定義を確認
3. 実際に保存されたデータを確認
4. 必要に応じて単位を修正